<!doctype html>
<html lang="es">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <title>Inventario Profesional</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <style>
      :root {
        --primary: #4f46e5;
        --accent: #7c3aed;
        --bg-dark: #0f172a;
        --card-glass: rgba(30, 41, 59, 0.8);
        --text-bright: #ffffff;
        --text-muted: #cbd5e1;
      }

      body {
        background: radial-gradient(circle at top right, #1e1b4b, #0f172a);
        background-attachment: fixed;
        color: var(--text-bright);
        font-family: "Segoe UI", system-ui, sans-serif;
        padding-top: 80px;
        min-height: 100vh;
      }

      /* Navbar */
      .navbar {
        background: rgba(15, 23, 42, 0.9) !important;
        backdrop-filter: blur(15px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .navbar-brand {
        font-weight: 800;
        color: var(--text-bright) !important;
      }

      /* Tarjetas */
      .card {
        background: var(--card-glass);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        transition: 0.3s;
      }
      .card:hover {
        transform: translateY(-5px);
        border-color: var(--primary);
      }
      .card-img-top {
        height: 180px;
        object-fit: cover;
        border-radius: 20px 20px 0 0;
      }
      .card-title {
        color: var(--text-bright);
        font-weight: 700;
        margin: 0;
      }

      /* Inputs */
      .form-section {
        background: var(--card-glass);
        border-radius: 24px;
        padding: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      label {
        color: var(--text-bright);
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 0.9rem;
      }
      .form-control,
      .form-select {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white !important;
        border-radius: 12px;
      }

      /* Cámara Area */
      .photo-area {
        border: 2px dashed var(--primary);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        background: rgba(79, 70, 229, 0.1);
        position: relative;
        cursor: pointer;
      }
      .photo-area i {
        font-size: 2.5rem;
        color: var(--primary);
      }
      #imagen {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
      }

      /* Botones */
      .btn-primary {
        background: linear-gradient(45deg, var(--primary), var(--accent));
        border: none;
        border-radius: 12px;
        font-weight: 700;
      }
      .btn-config {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
      }

      .modal-content {
        background: #1e293b;
        color: white;
        border-radius: 25px;
      }
      .btn-close {
        filter: invert(1);
      }
      .status-tag {
        font-size: 0.7rem;
        font-weight: 800;
        padding: 4px 10px;
        border-radius: 8px;
        text-transform: uppercase;
        background: var(--primary);
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#">INVENTARIO</a>
        <div class="d-flex gap-2">
          <button
            class="btn btn-sm text-white"
            onclick="switchTab('galeriaContainer')"
          >
            Lista
          </button>
          <button
            class="btn btn-primary btn-sm px-3"
            onclick="switchTab('ingresar')"
          >
            NUEVO
          </button>
          <button class="btn btn-config btn-sm px-2" onclick="showConfig()">
            <i class="bi bi-gear-fill"></i>
          </button>
        </div>
      </div>
    </nav>

    <div class="container py-4 seccion" id="galeriaContainer">
      <h3 class="fw-bold mb-4">Herramientas</h3>
      <div id="loader" class="text-center py-5" style="display: none">
        <div class="spinner-border text-primary"></div>
      </div>
      <div class="row g-4" id="galeria"></div>
    </div>

    <div class="container py-4 seccion" id="ingresar" style="display: none">
      <div class="row justify-content-center">
        <div class="col-lg-6">
          <div class="form-section shadow-lg">
            <h3 class="fw-bold mb-4">Nuevo Registro</h3>
            <form id="formHerramienta">
              <div class="mb-3">
                <label>Nombre</label>
                <input type="text" id="nombre" class="form-control" required />
              </div>
              <div class="row">
                <div class="col-6 mb-3">
                  <label>Estado</label>
                  <select id="estado" class="form-select"></select>
                </div>
                <div class="col-6 mb-3">
                  <label>Fecha</label>
                  <input type="date" id="fecha" class="form-control" required />
                </div>
              </div>
              <div class="mb-3 text-center">
                <label>Capturar Foto</label>
                <div class="photo-area">
                  <i class="bi bi-camera-fill"></i>
                  <p id="fileNameDisplay" class="m-0 mt-2 small">
                    Toca para abrir cámara
                  </p>
                  <input
                    type="file"
                    id="imagen"
                    accept="image/*"
                    capture="environment"
                    required
                  />
                </div>
              </div>
              <div class="mb-4">
                <label>Descripción</label>
                <textarea
                  id="descripcion"
                  class="form-control"
                  rows="2"
                ></textarea>
              </div>
              <button
                type="submit"
                id="btnAgregar"
                class="btn btn-primary w-100 py-3"
              >
                GUARDAR EN BASE DE DATOS
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="configModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="fw-bold">Opciones de Estado</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body p-4">
            <div class="mb-3">
              <label>Agregar nueva opción (ej: En Reparación)</label>
              <div class="input-group">
                <input
                  type="text"
                  id="nuevoEstado"
                  class="form-control"
                  placeholder="Nombre del estado"
                />
                <button class="btn btn-primary" onclick="addEstadoOp()">
                  Añadir
                </button>
              </div>
            </div>
            <label>Estados actuales:</label>
            <ul
              id="listaEstados"
              class="list-group list-group-flush rounded-3 mt-2"
            ></ul>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 class="fw-bold m-0" id="modalNombre"></h4>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <form id="formEdicion">
              <input type="hidden" id="modalId" />
              <img
                id="modalImagen"
                src=""
                class="rounded-4 w-100 mb-3"
                style="height: 220px; object-fit: cover; border: 1px solid #444"
              />
              <div class="row g-2 mb-3">
                <div class="col-6">
                  <label class="small text-muted mb-1">Estado</label>
                  <select id="modalEstadoEditable" class="form-select"></select>
                </div>
                <div class="col-6">
                  <label class="small text-muted mb-1">Reemplazos</label>
                  <input
                    type="number"
                    id="modalReemplazosEditable"
                    class="form-control"
                    readonly
                  />
                </div>
              </div>
              <div class="mb-4">
                <label class="small text-muted mb-1">Descripción</label>
                <textarea
                  id="modalDescripcionEditable"
                  class="form-control"
                  rows="2"
                ></textarea>
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary flex-grow-1">
                  ACTUALIZAR +1
                </button>
                <button
                  type="button"
                  id="btnEliminar"
                  class="btn btn-outline-danger"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const _URL = "https://cfhyghkszfkktdlqdaqy.supabase.co";
      const _KEY = "sb_publishable_pYd42nEtQuJU7yX6eJuhMA_8wQCXA5m";
      const sb = supabase.createClient(_URL, _KEY);
      const BUCKET = "imagenes-herramientas";

      let opcionesEstado = ["Bueno", "Regular", "Malo"];

      function switchTab(id) {
        document
          .querySelectorAll(".seccion")
          .forEach((s) => (s.style.display = "none"));
        document.getElementById(id).style.display = "block";
        if (id === "galeriaContainer") fetchAll();
        updateStateSelectors();
      }

      function updateStateSelectors() {
        const selects = [
          document.getElementById("estado"),
          document.getElementById("modalEstadoEditable"),
        ];
        selects.forEach((sel) => {
          const valActual = sel.value;
          sel.innerHTML = opcionesEstado
            .map((o) => `<option value="${o}">${o}</option>`)
            .join("");
          if (valActual) sel.value = valActual;
        });
      }

      function showConfig() {
        const modal = new bootstrap.Modal(
          document.getElementById("configModal"),
        );
        renderEstadosConfig();
        modal.show();
      }

      function renderEstadosConfig() {
        const lista = document.getElementById("listaEstados");
        lista.innerHTML = opcionesEstado
          .map(
            (o, i) => `
                <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center border-secondary">
                    ${o}
                    <button class="btn btn-sm btn-danger" onclick="removeEstadoOp(${i})"><i class="bi bi-x"></i></button>
                </li>
            `,
          )
          .join("");
      }

      function addEstadoOp() {
        const val = document.getElementById("nuevoEstado").value.trim();
        if (val) {
          opcionesEstado.push(val);
          document.getElementById("nuevoEstado").value = "";
          renderEstadosConfig();
          updateStateSelectors();
        }
      }

      function removeEstadoOp(i) {
        opcionesEstado.splice(i, 1);
        renderEstadosConfig();
        updateStateSelectors();
      }

      document.getElementById("imagen").addEventListener("change", (e) => {
        document.getElementById("fileNameDisplay").innerText =
          e.target.files[0]?.name || "Foto capturada";
      });

      async function fetchAll() {
        const galeria = document.getElementById("galeria");
        const loader = document.getElementById("loader");
        loader.style.display = "block";
        const { data, error } = await sb
          .from("herramientas")
          .select("*")
          .order("created_at", { ascending: false });
        loader.style.display = "none";

        if (error) return;
        galeria.innerHTML = data.length
          ? ""
          : '<div class="col-12 text-center text-muted py-5">No hay herramientas</div>';

        data.forEach((h) => {
          const col = document.createElement("div");
          col.className = "col-6 col-md-4 col-lg-3";
          col.innerHTML = `
                    <div class="card h-100" onclick="showDetail(${JSON.stringify(h).replace(/"/g, "&quot;")})">
                        <img src="${h.imagen_url || "https://via.placeholder.com/300"}" class="card-img-top">
                        <div class="card-body text-center p-3">
                            <h6 class="card-title text-truncate mb-2">${h.nombre}</h6>
                            <span class="status-tag">${h.estado}</span>
                        </div>
                    </div>
                `;
          galeria.appendChild(col);
        });
      }

      function showDetail(h) {
        updateStateSelectors();
        document.getElementById("modalId").value = h.id;
        document.getElementById("modalNombre").innerText = h.nombre;
        document.getElementById("modalImagen").src = h.imagen_url;
        document.getElementById("modalEstadoEditable").value = h.estado;
        document.getElementById("modalReemplazosEditable").value =
          h.reemplazos || 0;
        document.getElementById("modalDescripcionEditable").value =
          h.descripcion || "";
        new bootstrap.Modal(document.getElementById("infoModal")).show();
      }

      document.getElementById("formHerramienta").onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById("btnAgregar");
        btn.disabled = true;

        try {
          const file = document.getElementById("imagen").files[0];
          const fileName = `${Date.now()}_${file.name}`;
          await sb.storage.from(BUCKET).upload(fileName, file);
          const { data: urlData } = sb.storage
            .from(BUCKET)
            .getPublicUrl(fileName);

          await sb.from("herramientas").insert([
            {
              nombre: document.getElementById("nombre").value,
              estado: document.getElementById("estado").value,
              descripcion: document.getElementById("descripcion").value,
              fecha_ingreso: document.getElementById("fecha").value,
              reemplazos: 0,
              imagen_url: urlData.publicUrl,
            },
          ]);

          e.target.reset();
          document.getElementById("fileNameDisplay").innerText =
            "Toca para abrir cámara";
          switchTab("galeriaContainer");
        } catch (err) {
          alert("Error al subir");
        } finally {
          btn.disabled = false;
        }
      };

      document.getElementById("formEdicion").onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById("modalId").value;
        const currentR = parseInt(
          document.getElementById("modalReemplazosEditable").value,
        );

        await sb
          .from("herramientas")
          .update({
            estado: document.getElementById("modalEstadoEditable").value,
            descripcion: document.getElementById("modalDescripcionEditable")
              .value,
            reemplazos: currentR + 1,
          })
          .eq("id", id);

        bootstrap.Modal.getInstance(
          document.getElementById("infoModal"),
        ).hide();
        fetchAll();
      };

      document.getElementById("btnEliminar").onclick = async () => {
        if (!confirm("¿Borrar permanentemente?")) return;
        await sb
          .from("herramientas")
          .delete()
          .eq("id", document.getElementById("modalId").value);
        bootstrap.Modal.getInstance(
          document.getElementById("infoModal"),
        ).hide();
        fetchAll();
      };

      // Inicio
      updateStateSelectors();
      fetchAll();
    </script>
  </body>
</html>
