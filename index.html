<!doctype html>
<html lang="es">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <title>Inventario Pro</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <style>
      :root {
        --primary: #4f46e5;
        --accent: #7c3aed;
        --bg-dark: #0f172a;
        --card-glass: rgba(30, 41, 59, 0.7);
        --text-bright: #ffffff; /* Blanco puro para legibilidad */
        --text-muted: #cbd5e1; /* Gris claro para detalles */
      }

      body {
        background: radial-gradient(circle at top right, #1e1b4b, #0f172a);
        background-attachment: fixed;
        color: var(--text-bright);
        font-family:
          "Segoe UI",
          system-ui,
          -apple-system,
          sans-serif;
        padding-top: 80px;
        min-height: 100vh;
      }

      /* Navbar Transparente */
      .navbar {
        background: rgba(15, 23, 42, 0.8) !important;
        backdrop-filter: blur(15px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .navbar-brand {
        font-weight: 800;
        color: var(--text-bright) !important;
        letter-spacing: 1px;
      }

      /* Tarjetas Estilo Glass */
      .card {
        background: var(--card-glass);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        transition: all 0.3s ease;
      }
      .card:hover {
        transform: translateY(-8px);
        border-color: var(--primary);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
      }
      .card-img-top {
        height: 180px;
        object-fit: cover;
        border-radius: 20px 20px 0 0;
      }
      .card-title {
        color: var(--text-bright);
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      /* Inputs y Formulario */
      .form-section {
        background: var(--card-glass);
        border-radius: 24px;
        padding: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      label {
        color: var(--text-bright);
        font-weight: 600;
        margin-bottom: 8px;
      }
      .form-control,
      .form-select {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white !important;
        border-radius: 12px;
        padding: 12px;
      }
      .form-control::placeholder {
        color: #94a3b8;
      }
      .form-control:focus {
        background: rgba(15, 23, 42, 0.8);
        border-color: var(--primary);
        box-shadow: none;
      }

      /* Cargador de Foto Pro */
      .photo-area {
        border: 2px dashed rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        background: rgba(255, 255, 255, 0.03);
        cursor: pointer;
        position: relative;
        transition: 0.3s;
      }
      .photo-area:hover {
        border-color: var(--primary);
        background: rgba(255, 255, 255, 0.07);
      }
      .photo-area i {
        font-size: 2rem;
        color: var(--primary);
      }
      #imagen {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
      }

      /* Botones */
      .btn-primary {
        background: linear-gradient(45deg, var(--primary), var(--accent));
        border: none;
        border-radius: 12px;
        font-weight: 700;
        padding: 12px;
      }

      /* Notificaciones y Modales */
      .modal-content {
        background: #1e293b;
        color: white;
        border-radius: 25px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .btn-close {
        filter: invert(1);
      }
      .custom-toast {
        background: var(--primary);
        color: white;
        border-radius: 12px;
      }

      /* Badges de Estado */
      .status-tag {
        font-size: 0.7rem;
        font-weight: 800;
        padding: 4px 10px;
        border-radius: 8px;
        text-transform: uppercase;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#">INVENTARIO</a>
        <div class="d-flex gap-2">
          <button
            class="btn btn-sm text-white"
            onclick="switchTab('galeriaContainer')"
          >
            Lista
          </button>
          <button
            class="btn btn-primary btn-sm px-3"
            onclick="switchTab('ingresar')"
          >
            NUEVO
          </button>
        </div>
      </div>
    </nav>

    <div class="container py-4 seccion" id="galeriaContainer">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold m-0">Herramientas</h3>
        <div
          id="loader"
          class="spinner-border spinner-border-sm text-primary"
          style="display: none"
        ></div>
      </div>
      <div class="row g-4" id="galeria"></div>
    </div>

    <div class="container py-4 seccion" id="ingresar" style="display: none">
      <div class="row justify-content-center">
        <div class="col-lg-6">
          <div class="form-section shadow-lg">
            <h3 class="fw-bold mb-4 text-center">Registro de Equipo</h3>
            <form id="formHerramienta">
              <div class="mb-3">
                <label>Nombre</label>
                <input
                  type="text"
                  id="nombre"
                  class="form-control"
                  placeholder="Nombre de la herramienta"
                  required
                />
              </div>
              <div class="row">
                <div class="col-6 mb-3">
                  <label>Estado</label>
                  <select id="estado" class="form-select">
                    <option value="Bueno">Bueno ✅</option>
                    <option value="Regular">Regular ⚠️</option>
                    <option value="Malo">Malo ❌</option>
                  </select>
                </div>
                <div class="col-6 mb-3">
                  <label>Fecha</label>
                  <input type="date" id="fecha" class="form-control" required />
                </div>
              </div>
              <div class="mb-3">
                <label>Foto de la Herramienta</label>
                <div class="photo-area">
                  <i class="bi bi-cloud-arrow-up"></i>
                  <p id="fileNameDisplay" class="m-0 mt-2 small text-muted">
                    Haz clic para elegir imagen
                  </p>
                  <input type="file" id="imagen" accept="image/*" required />
                </div>
              </div>
              <div class="mb-4">
                <label>Descripción</label>
                <textarea
                  id="descripcion"
                  class="form-control"
                  rows="2"
                  placeholder="Detalles técnicos..."
                ></textarea>
              </div>
              <button
                type="submit"
                id="btnAgregar"
                class="btn btn-primary w-100 py-3 shadow"
              >
                GUARDAR REGISTRO
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-2xl">
          <div class="modal-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 class="fw-bold m-0" id="modalNombre"></h4>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <form id="formEdicion">
              <input type="hidden" id="modalId" />
              <img
                id="modalImagen"
                src=""
                class="rounded-4 w-100 mb-3 border border-secondary"
                style="height: 240px; object-fit: cover"
              />

              <div class="row g-2 mb-3">
                <div class="col-6">
                  <label class="small text-muted mb-1">Estado</label>
                  <select id="modalEstadoEditable" class="form-select">
                    <option value="Bueno">Bueno</option>
                    <option value="Regular">Regular</option>
                    <option value="Malo">Malo</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="small text-muted mb-1">Reemplazos</label>
                  <input
                    type="number"
                    id="modalReemplazosEditable"
                    class="form-control"
                    readonly
                  />
                </div>
              </div>
              <div class="mb-4">
                <label class="small text-muted mb-1">Descripción</label>
                <textarea
                  id="modalDescripcionEditable"
                  class="form-control"
                  rows="2"
                ></textarea>
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary flex-grow-1">
                  Actualizar +1
                </button>
                <button
                  type="button"
                  id="btnEliminar"
                  class="btn btn-outline-danger px-3"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div
        id="liveToast"
        class="toast custom-toast border-0"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex p-2">
          <div class="toast-body fw-bold" id="toastMsg"></div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
          ></button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const _URL = "https://cfhyghkszfkktdlqdaqy.supabase.co";
      const _KEY = "sb_publishable_pYd42nEtQuJU7yX6eJuhMA_8wQCXA5m";
      const sb = supabase.createClient(_URL, _KEY);
      const BUCKET = "imagenes-herramientas";

      function switchTab(id) {
        document
          .querySelectorAll(".seccion")
          .forEach((s) => (s.style.display = "none"));
        document.getElementById(id).style.display = "block";
        if (id === "galeriaContainer") fetchAll();
      }

      function showToast(msg) {
        document.getElementById("toastMsg").innerText = msg;
        bootstrap.Toast.getOrCreateInstance(
          document.getElementById("liveToast"),
        ).show();
      }

      document
        .getElementById("imagen")
        .addEventListener("change", function (e) {
          const fileName =
            e.target.files[0]?.name || "Haz clic para elegir imagen";
          document.getElementById("fileNameDisplay").innerText = fileName;
        });

      async function fetchAll() {
        const galeria = document.getElementById("galeria");
        const loader = document.getElementById("loader");
        loader.style.display = "block";

        const { data, error } = await sb
          .from("herramientas")
          .select("*")
          .order("created_at", { ascending: false });
        loader.style.display = "none";

        if (error) return console.error(error);
        galeria.innerHTML = data.length
          ? ""
          : '<div class="col-12 text-center text-muted py-5">Sin datos</div>';

        data.forEach((h) => {
          const color =
            h.estado === "Bueno"
              ? "success"
              : h.estado === "Regular"
                ? "warning"
                : "danger";
          const col = document.createElement("div");
          col.className = "col-6 col-md-4 col-lg-3";
          col.innerHTML = `
                    <div class="card h-100" onclick="showDetail(${JSON.stringify(h).replace(/"/g, "&quot;")})">
                        <img src="${h.imagen_url || "https://via.placeholder.com/300"}" class="card-img-top">
                        <div class="card-body text-center p-3">
                            <h6 class="card-title text-truncate mb-2">${h.nombre}</h6>
                            <span class="status-tag bg-${color} text-dark">${h.estado}</span>
                        </div>
                    </div>
                `;
          galeria.appendChild(col);
        });
      }

      function showDetail(h) {
        document.getElementById("modalId").value = h.id;
        document.getElementById("modalNombre").innerText = h.nombre;
        document.getElementById("modalImagen").src = h.imagen_url;
        document.getElementById("modalEstadoEditable").value = h.estado;
        document.getElementById("modalReemplazosEditable").value =
          h.reemplazos || 0;
        document.getElementById("modalDescripcionEditable").value =
          h.descripcion || "";
        new bootstrap.Modal(document.getElementById("infoModal")).show();
      }

      document.getElementById("formHerramienta").onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById("btnAgregar");
        btn.disabled = true;

        try {
          const file = document.getElementById("imagen").files[0];
          const fileName = `${Date.now()}_${file.name}`;
          await sb.storage.from(BUCKET).upload(fileName, file);
          const { data: urlData } = sb.storage
            .from(BUCKET)
            .getPublicUrl(fileName);

          const { error } = await sb.from("herramientas").insert([
            {
              nombre: document.getElementById("nombre").value,
              estado: document.getElementById("estado").value,
              descripcion: document.getElementById("descripcion").value,
              fecha_ingreso: document.getElementById("fecha").value,
              reemplazos: 0,
              imagen_url: urlData.publicUrl,
            },
          ]);

          if (error) throw error;
          showToast("¡Herramienta guardada!");
          e.target.reset();
          document.getElementById("fileNameDisplay").innerText =
            "Haz clic para elegir imagen";
          switchTab("galeriaContainer");
        } catch (err) {
          showToast("Error al procesar.");
        } finally {
          btn.disabled = false;
        }
      };

      document.getElementById("formEdicion").onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById("modalId").value;
        const currentR = parseInt(
          document.getElementById("modalReemplazosEditable").value,
        );

        await sb
          .from("herramientas")
          .update({
            estado: document.getElementById("modalEstadoEditable").value,
            descripcion: document.getElementById("modalDescripcionEditable")
              .value,
            reemplazos: currentR + 1,
          })
          .eq("id", id);

        bootstrap.Modal.getInstance(
          document.getElementById("infoModal"),
        ).hide();
        showToast("Registro actualizado.");
        fetchAll();
      };

      document.getElementById("btnEliminar").onclick = async () => {
        if (!confirm("¿Borrar permanentemente?")) return;
        const id = document.getElementById("modalId").value;
        await sb.from("herramientas").delete().eq("id", id);
        bootstrap.Modal.getInstance(
          document.getElementById("infoModal"),
        ).hide();
        showToast("Eliminado.");
        fetchAll();
      };

      fetchAll();
    </script>
  </body>
</html>
