<!doctype html>
<html lang="es">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <title>Inventario Pro</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <style>
      :root {
        --primary: #4f46e5;
        --accent: #7c3aed;
        --bg-dark: #0f172a;
        --card-glass: rgba(30, 41, 59, 0.95);
        --text-bright: #ffffff;
      }

      body {
        background: radial-gradient(circle at top right, #1e1b4b, #0f172a);
        background-attachment: fixed;
        color: var(--text-bright);
        font-family: "Segoe UI", system-ui, sans-serif;
        padding-top: 80px;
        min-height: 100vh;
      }

      /* Navbar */
      .navbar {
        background: rgba(15, 23, 42, 0.95) !important;
        backdrop-filter: blur(15px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .navbar-brand {
        font-weight: 800;
        color: var(--text-bright) !important;
        letter-spacing: 1px;
      }

      /* Tarjetas */
      .card {
        background: var(--card-glass);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        transition: 0.3s;
        cursor: pointer;
      }
      .card:hover {
        transform: translateY(-5px);
        border-color: var(--primary);
      }
      .card-img-top {
        height: 180px;
        object-fit: cover;
        border-radius: 20px 20px 0 0;
        background: #000;
      }
      .card-title {
        color: var(--text-bright);
        font-weight: 700;
        margin: 0;
      }

      /* Formularios */
      .form-section {
        background: var(--card-glass);
        border-radius: 24px;
        padding: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      label {
        color: var(--text-bright);
        font-weight: 700;
        margin-bottom: 8px;
      }
      .form-control,
      .form-select {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white !important;
        border-radius: 12px;
        padding: 12px;
      }
      .form-control:focus {
        background: #0f172a;
        border-color: var(--primary);
        box-shadow: none;
      }

      /* Cámara */
      .photo-area {
        border: 2px dashed var(--primary);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        background: rgba(79, 70, 229, 0.1);
        position: relative;
      }
      .photo-area i {
        font-size: 2.5rem;
        color: var(--primary);
      }
      #imagen {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
      }

      /* Botones y Modales */
      .btn-primary {
        background: linear-gradient(45deg, var(--primary), var(--accent));
        border: none;
        border-radius: 12px;
        font-weight: 700;
      }
      .modal-content {
        background: #1e293b;
        color: white;
        border-radius: 25px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .btn-close {
        filter: invert(1);
      }
      .status-tag {
        font-size: 0.75rem;
        font-weight: 800;
        padding: 4px 12px;
        border-radius: 8px;
        text-transform: uppercase;
        background: var(--primary);
        color: white;
      }

      /* Notificación Toast */
      .custom-toast {
        background: var(--primary);
        color: white;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#">INVENTARIO</a>
        <div class="d-flex gap-2">
          <button
            class="btn btn-sm text-white fw-bold"
            onclick="switchTab('galeriaContainer')"
          >
            LISTA
          </button>
          <button
            class="btn btn-primary btn-sm px-4"
            onclick="switchTab('ingresar')"
          >
            NUEVO
          </button>
        </div>
      </div>
    </nav>

    <div class="container py-4 seccion" id="galeriaContainer">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold m-0 text-white">Herramientas</h3>
        <div
          id="loader"
          class="spinner-border spinner-border-sm text-primary"
          style="display: none"
        ></div>
      </div>
      <div class="row g-4" id="galeria"></div>
    </div>

    <div class="container py-4 seccion" id="ingresar" style="display: none">
      <div class="row justify-content-center">
        <div class="col-lg-6">
          <div class="form-section shadow-lg">
            <h3 class="fw-bold mb-4 text-center">Nuevo Registro</h3>
            <form id="formHerramienta">
              <div class="mb-3">
                <label>Nombre del Objeto</label
                ><input
                  type="text"
                  id="nombre"
                  class="form-control"
                  placeholder="Ej. Taladro"
                  required
                />
              </div>
              <div class="row">
                <div class="col-6 mb-3">
                  <label>Estado</label>
                  <select id="estado" class="form-select">
                    <option value="Bueno">Bueno</option>
                    <option value="Regular">Regular</option>
                    <option value="Malo">Malo</option>
                  </select>
                </div>
                <div class="col-6 mb-3">
                  <label>Fecha</label
                  ><input
                    type="date"
                    id="fecha"
                    class="form-control"
                    required
                  />
                </div>
              </div>
              <div class="mb-3 text-center">
                <label>Foto</label>
                <div class="photo-area">
                  <i class="bi bi-camera-fill"></i>
                  <p
                    id="fileNameDisplay"
                    class="m-0 mt-2 small fw-bold text-white"
                  >
                    Toca para TOMAR FOTO
                  </p>
                  <input
                    type="file"
                    id="imagen"
                    accept="image/*"
                    capture="environment"
                    required
                  />
                </div>
              </div>
              <div class="mb-4">
                <label>Descripción</label
                ><textarea
                  id="descripcion"
                  class="form-control"
                  rows="2"
                  placeholder="Detalles..."
                ></textarea>
              </div>
              <button
                type="submit"
                id="btnAgregar"
                class="btn btn-primary w-100 py-3"
              >
                SUBIR A BASE DE DATOS
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 class="fw-bold m-0" id="modalNombre"></h4>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <form id="formEdicion">
              <input type="hidden" id="modalId" />
              <img
                id="modalImagen"
                src=""
                class="rounded-4 w-100 mb-3"
                style="height: 220px; object-fit: cover; border: 1px solid #444"
              />
              <div class="row g-2 mb-3">
                <div class="col-6">
                  <label class="small text-white-50 mb-1 fw-bold">Estado</label>
                  <select id="modalEstadoEditable" class="form-select">
                    <option value="Bueno">Bueno</option>
                    <option value="Regular">Regular</option>
                    <option value="Malo">Malo</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="small text-white-50 mb-1 fw-bold"
                    >Reemplazos</label
                  ><input
                    type="number"
                    id="modalReemplazosEditable"
                    class="form-control"
                    readonly
                  />
                </div>
              </div>
              <div class="mb-4">
                <label class="small text-white-50 mb-1 fw-bold"
                  >Descripción</label
                ><textarea
                  id="modalDescripcionEditable"
                  class="form-control"
                  rows="2"
                ></textarea>
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary flex-grow-1">
                  ACTUALIZAR +1
                </button>
                <button
                  type="button"
                  class="btn btn-outline-danger"
                  onclick="abrirConfirmacionBorrado()"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content text-center">
          <div class="modal-body p-4">
            <i class="bi bi-exclamation-circle text-warning display-4 mb-3"></i>
            <h5 class="fw-bold">¿Borrar registro?</h5>
            <p class="small text-white-50">Esta acción no se puede deshacer.</p>
            <div class="d-flex gap-2 justify-content-center mt-4">
              <button class="btn btn-secondary w-50" data-bs-dismiss="modal">
                Cancelar
              </button>
              <button
                class="btn btn-danger w-50"
                onclick="borrarDefinitivamente()"
              >
                Borrar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div
        id="liveToast"
        class="toast custom-toast border-0"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex p-3">
          <div id="toastMsg" class="toast-body"></div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
          ></button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const _URL = "https://trebtgrojfwfvpckyhpr.supabase.co";
      const _KEY = "sb_publishable_vCabnmPg9X_YpqPBlxUXiw__KzqJJpY";
      const sb = supabase.createClient(_URL, _KEY);
      const BUCKET = "imagenes-herramientas";

      function switchTab(id) {
        document
          .querySelectorAll(".seccion")
          .forEach((s) => (s.style.display = "none"));
        document.getElementById(id).style.display = "block";
        if (id === "galeriaContainer") fetchAll();
      }

      function showToast(msg) {
        document.getElementById("toastMsg").innerText = msg;
        bootstrap.Toast.getOrCreateInstance(
          document.getElementById("liveToast"),
        ).show();
      }

      document.getElementById("imagen").addEventListener("change", (e) => {
        document.getElementById("fileNameDisplay").innerText = e.target.files[0]
          ? "Foto lista ✔"
          : "Toca para TOMAR FOTO";
      });

      async function fetchAll() {
        const galeria = document.getElementById("galeria");
        const loader = document.getElementById("loader");
        loader.style.display = "block";
        const { data, error } = await sb
          .from("herramientas")
          .select("*")
          .order("created_at", { ascending: false });
        loader.style.display = "none";

        if (error) return;
        galeria.innerHTML = data.length
          ? ""
          : '<div class="col-12 text-center text-muted py-5">No hay herramientas registradas.</div>';

        data.forEach((h) => {
          const col = document.createElement("div");
          col.className = "col-6 col-md-4 col-lg-3";
          col.innerHTML = `
                    <div class="card h-100 shadow-lg" onclick="showDetail(${JSON.stringify(h).replace(/"/g, "&quot;")})">
                        <img src="${h.imagen_url}" class="card-img-top" onerror="this.src='https://via.placeholder.com/300?text=Error+Carga'">
                        <div class="card-body text-center p-3">
                            <h6 class="card-title text-truncate mb-2">${h.nombre}</h6>
                            <span class="status-tag">${h.estado}</span>
                        </div>
                    </div>`;
          galeria.appendChild(col);
        });
      }

      function showDetail(h) {
        document.getElementById("modalId").value = h.id;
        document.getElementById("modalNombre").innerText = h.nombre;
        document.getElementById("modalImagen").src = h.imagen_url;
        document.getElementById("modalEstadoEditable").value = h.estado;
        document.getElementById("modalReemplazosEditable").value =
          h.reemplazos || 0;
        document.getElementById("modalDescripcionEditable").value =
          h.descripcion || "";
        new bootstrap.Modal(document.getElementById("infoModal")).show();
      }

      document.getElementById("formHerramienta").onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById("btnAgregar");
        btn.disabled = true;
        btn.innerText = "Subiendo...";

        try {
          const file = document.getElementById("imagen").files[0];
          const fileName = `${Date.now()}_${file.name}`;

          // Subir imagen
          const { error: storageErr } = await sb.storage
            .from(BUCKET)
            .upload(fileName, file);
          if (storageErr) throw storageErr;

          // URL pública
          const { data: urlData } = sb.storage
            .from(BUCKET)
            .getPublicUrl(fileName);

          // Guardar en BD
          const { error: dbErr } = await sb.from("herramientas").insert([
            {
              nombre: document.getElementById("nombre").value,
              estado: document.getElementById("estado").value,
              descripcion: document.getElementById("descripcion").value,
              fecha_ingreso: document.getElementById("fecha").value,
              reemplazos: 0,
              imagen_url: urlData.publicUrl,
            },
          ]);

          if (dbErr) throw dbErr;

          showToast("¡Herramienta guardada!");
          e.target.reset();
          document.getElementById("fileNameDisplay").innerText =
            "Toca para TOMAR FOTO";
          setTimeout(() => {
            switchTab("galeriaContainer");
          }, 1000);
        } catch (err) {
          showToast("Error al guardar.");
        } finally {
          btn.disabled = false;
          btn.innerText = "SUBIR A BASE DE DATOS";
        }
      };

      document.getElementById("formEdicion").onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById("modalId").value;
        const r = parseInt(
          document.getElementById("modalReemplazosEditable").value,
        );

        await sb
          .from("herramientas")
          .update({
            estado: document.getElementById("modalEstadoEditable").value,
            descripcion: document.getElementById("modalDescripcionEditable")
              .value,
            reemplazos: r + 1,
          })
          .eq("id", id);

        bootstrap.Modal.getInstance(
          document.getElementById("infoModal"),
        ).hide();
        showToast("Actualizado (+1 Reemplazo)");
        fetchAll();
      };

      // --- LÓGICA DE BORRADO SIN ALERTAS ---
      let idParaBorrar = null;

      function abrirConfirmacionBorrado() {
        // Guardamos el ID que queremos borrar
        idParaBorrar = document.getElementById("modalId").value;
        // Cerramos el modal de info
        bootstrap.Modal.getInstance(
          document.getElementById("infoModal"),
        ).hide();
        // Abrimos el modal de confirmación
        new bootstrap.Modal(document.getElementById("deleteModal")).show();
      }

      async function borrarDefinitivamente() {
        if (!idParaBorrar) return;

        await sb.from("herramientas").delete().eq("id", idParaBorrar);

        // Cerrar modal de confirmación
        bootstrap.Modal.getInstance(
          document.getElementById("deleteModal"),
        ).hide();
        showToast("Registro eliminado.");
        fetchAll();
      }

      fetchAll();
    </script>
  </body>
</html>
